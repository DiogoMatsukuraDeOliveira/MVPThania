<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MVP - ConectaCom</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet"/>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
  :root {
    --primary: #3366CC;
    --accent: #FF6F61;
    --light: #F7F9FC;
    --dark: #1F2A44;
    --font: 'Montserrat', sans-serif;
  }

  body {
    font-family: var(--font);
    background: var(--light);
    color: var(--dark);
  }

  h1 { font-weight: 600; color: var(--primary); }

  /* NAV TABS */
  .nav-tabs { border-bottom: none; justify-content: center; }
  .nav-tabs .nav-item { margin: 0 0.5rem; }
  .nav-tabs .nav-link {
    position: relative; display: inline-block;
    padding: 10px 24px; border: none; border-radius: 50px;
    background: transparent; color: var(--dark); font-weight: 500;
    transition: background-color .3s, transform .2s, box-shadow .2s, color .3s;
  }
  .nav-tabs .nav-link:hover { background: rgba(51,102,204,0.1); transform: translateY(-2px); }
  .nav-tabs .nav-link.active {
    background: var(--primary); color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .nav-tabs .nav-link.active::after {
    content: ''; position: absolute; bottom: -4px; left: 50%;
    transform: translateX(-50%); width: 50%; height: 4px;
    background: var(--accent); border-radius: 2px;
  }

  a { text-decoration: none; color: inherit; }

  /* CARD & BUTTON */
  .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform .2s; }
  .card:hover { transform: translateY(-4px); }
  .btn-primary, .btn-success { background: var(--primary); border: none; transition: background .2s, transform .2s; }
  .btn-primary:hover, .btn-success:hover { background: #274b8a; transform: translateY(-1px); }

  .form-control { border-radius: 6px; padding: 10px; border: 1px solid #ccc; transition: border-color .2s, box-shadow .2s; }
  .form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 0.2rem rgba(255,111,97,0.25); }

  .card-img-top { width: 100%; max-height: 250px; object-fit: contain; border-radius: 8px; cursor: pointer; }
  a.location-link { color: var(--primary); text-decoration: none; transition: color .2s; }
  a.location-link:hover { color: var(--accent); }

  /* IMAGE MODAL */
  .modal-dialog { max-width:90vw; margin:0 auto; }
  .modal-body { padding:0; max-height:90vh; overflow:hidden; }
  #modalImage { display:block; margin:0 auto; max-height:calc(90vh - 2rem); width:auto; object-fit:contain; }

  /* EVENT MODAL */
  #eventModal .modal-dialog { max-width:600px; margin:1.5rem auto; }
  #eventModal .modal-content { border-radius:12px; overflow:hidden; }
  #eventModal .modal-header { background: var(--primary); color:#fff; border-bottom:none; padding:1rem 1.5rem; }
  #eventModal .modal-title { font-weight:600; font-size:1.25rem; }
  #eventModal .modal-body { flex: 1 1 auto; overflow-y: auto; padding: 1rem 1.5rem; }
  #eventModal .modal-body .row > .col { margin-bottom:1rem; }
  #eventModal .modal-body .mb-3 { margin-bottom:1.25rem; }
  #eventModal .form-label { font-weight:500; }
  #eventModal .modal-footer { padding:1rem 1.5rem; border-top:none; display:flex; justify-content:flex-end; gap:0.5rem; }

  /* Candidate modal igual ao Event modal */
  #candidateModal .modal-dialog { max-width: 600px; margin: 1.5rem auto; }
  #candidateModal .modal-content { border-radius: 12px; overflow: hidden; }
  #candidateModal .modal-header { background: var(--primary); color: #fff; border-bottom: none; padding: 1rem 1.5rem; }
  #candidateModal .modal-title { font-weight: 600; font-size: 1.25rem; }
  #candidateModal .modal-body { flex: 1 1 auto; overflow-y: auto; padding: 1rem 1.5rem; }
  #candidateModal .modal-body .row > .col { margin-bottom: 1rem; }
  #candidateModal .modal-body .mb-3 { margin-bottom: 1.25rem; }
  #candidateModal .form-label { font-weight: 500; }
  #candidateModal .modal-footer { padding: 1rem 1.5rem; border-top: none; display: flex; justify-content: flex-end; gap: 0.5rem; }

  /* MAP */
  #mapContainer { display: flex; height: 500px; }
  #mapArea { flex: 1; position: relative; }
  #mapIframe { width: 100%; height: 100%; border: none; border-radius: 8px; display: none; }
  #mapPlaceholder {
    position: absolute; top:0; left:0; right:0; bottom:0;
    display: flex; justify-content:center; align-items:center;
    color:#666; background:#fff; border-radius:8px;
    padding:1rem; text-align:center;
  }
  #mapSidebar { width: 300px; border-left:1px solid #ddd; overflow-y:auto; background:#fff; padding:1rem; }
  #mapSidebar .list-group-item { cursor:pointer; transition:background .2s; }
  #mapSidebar .list-group-item:hover { background:#f7f7f7; }

  /* CUSTOM CALENDAR */
  .calendar-card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
  .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .calendar { display: grid; grid-template-columns: repeat(7,1fr); gap:5px; text-align:center; }
  .calendar .header { font-weight:600; padding:10px 0; }
  .calendar .day { background:#fff; border:1px solid #ddd; border-radius:6px; padding:5px; height:80px; position:relative; cursor:pointer; }
  .calendar .day.inactive { background:#f9f9f9; color:#999; cursor:default; }
  .calendar .date-number { font-weight:600; }
  .calendar .dot {
    width: 16px;
    height: 16px;
    background: var(--primary);
    border-radius: 50%;
    position: absolute;
    top: 50%; left: 50%; transform: translate(-50%, -50%);
  }

  /* 1) Cada coluna estica para ter a mesma altura */
  .tab-pane .row > .col-md-4 { display: flex; align-items: stretch; }

  /* 2) Cada card vira um flex‐container em coluna */
  .tab-pane .row > .col-md-4 .card {
    display: flex;
    flex-direction: column;
    width: 100%;
  }

  /* 3) O botão vai para a base do card */
  .tab-pane .row > .col-md-4 .card .btn { margin-top: auto; }

  /* Limita o tamanho máximo dos cards */
  #workshopsView .card, #professionalsView .card {
    max-width: 280px;
    margin-left: auto; margin-right: auto;
  }

  /* BUTTON SPACING IN CARDS */
  .card .card-actions { display: flex; justify-content: center; gap: 0.75rem; margin-top: 1rem; }
  .card .card-actions .btn { flex: 1; }
  </style>
</head>
<body>

  <!-- Botão Auth no topo -->
  <div class="position-fixed top-0 start-0 m-3" style="z-index:1050">
    <a href="auth.html" class="btn btn-outline-primary btn-sm">Área do Gestor</a>
  </div>

  <div class="container py-5">
    <h1 class="text-center mb-5">
      Conect<span class="text-gray">+</span>
    </h1>

    <!-- NAV TABS -->
    <ul class="nav nav-tabs justify-content-center mb-4">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#listView">Lista</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#calendarView">Calendário</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#mapView">Mapa</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#workshopsView">Workshops</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#professionalsView">Profissionais</button></li>
    </ul>

    <!-- TAB CONTENT (todas as abas dentro deste bloco) -->
    <div class="tab-content">

      <!-- LIST VIEW -->
      <div class="tab-pane fade show active" id="listView">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div class="d-flex">
            <input id="searchInput" class="form-control me-2" style="width:200px;" placeholder="Buscar título/data..."/>
            <input id="managerFilter" class="form-control me-2" style="width:240px;" placeholder="ID Gestor"/>
          </div>
          <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#eventModal">+ Novo Evento</button>
        </div>
        <div id="cardsContainer" class="row"></div>
      </div>

      <!-- CALENDAR VIEW -->
      <div class="tab-pane fade" id="calendarView">
        <div class="calendar-card">
          <div class="calendar-header">
            <button id="prevMonth" class="btn btn-outline-primary btn-sm">&lt;</button>
            <h5 id="monthLabel" class="mb-0"></h5>
            <button id="nextMonth" class="btn btn-outline-primary btn-sm">&gt;</button>
          </div>
          <div class="calendar" id="calendar"></div>
        </div>
      </div>

      <!-- MAP VIEW -->
      <div class="tab-pane fade" id="mapView">
        <div id="mapContainer">
          <div id="mapArea">
            <div id="mapPlaceholder">Clique em um evento à direita para ver sua localização no mapa</div>
            <iframe id="mapIframe"></iframe>
          </div>
          <div id="mapSidebar">
            <input id="mapSearch" class="form-control mb-3" placeholder="Pesquisar evento..."/>
            <div id="mapSidebarList" class="list-group"></div>
          </div>
        </div>
      </div>

      <!-- WORKSHOPS VIEW -->
      <div class="tab-pane fade" id="workshopsView">
        <div class="container py-4">
          <h3 class="mb-3">Workshops</h3>
          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
            <!-- Tricô (aberto) -->
            <div class="col-md-4 mb-4">
              <div class="card p-3">
                <img src="imagens/trico.png" class="card-img-top mb-3" alt="Tricô">
                <h5 class="card-title" style="font-weight: bold;">Workshop de Tricô</h5>
                <p>Aprenda pontos básicos e projetos simples de tricô.</p>
                <p style="font-weight: bold;">Horario das Aulas:</p>
                <p>• Terça-feira das 7:00 as 9:00</p>
                <p>• Sexta-feira das 13:00 as 15:00</p>
                <a id="registerBtnTrico"
                   href="https://chat.whatsapp.com/GlOpyNZDg1LE2uS7M2abcE"
                   target="_blank"
                   class="btn btn-primary w-100 text-center">
                  Inscrever
                </a>
              </div>
            </div>

            <!-- Pintura (aberto) -->
            <div class="col-md-4 mb-4">
              <div class="card p-3">
                <img src="imagens/pintura.png" class="card-img-top mb-3" alt="Pintura">
                <h5 class="card-title" style="font-weight: bold;">Workshop de Pintura (Presencial)</h5>
                <p>Técnicas de aquarela e pintura em tela.</p>
                <p style="font-weight: bold;">Horario das Aulas:</p>
                <p>• Terça-feira das 9:00 as 11:00</p>
                <p>• Sexta-feira das 15:00 as 17:00</p>
                <a id="registerBtnPintura"
                   href="https://chat.whatsapp.com/C7rhshFa9tSK9lVvqg7hvq"
                   target="_blank"
                   class="btn btn-primary w-100 text-center">
                  Inscrever
                </a>
              </div>
            </div>

            <!-- Natação (aberto) -->
            <div class="col-md-4 mb-4">
              <div class="card p-3">
                <img src="imagens/natação.png" class="card-img-top mb-3" alt="Natação">
                <h5 class="card-title" style="font-weight: bold;">Workshop de Natação (Presencial)</h5>
                <p>Aulas de natação adaptadas para 50+.</p>
                <p style="font-weight: bold;">Horário das Aulas:</p>
                <p>• Segunda-feira das 14:00 às 16:00</p>
                <p>• Quarta-feira das 10:00 às 12:00</p>
                <a id="registerBtnNatacao"
                   href="https://chat.whatsapp.com/Fw6BQgzX5meFWRzPcVOE2J"
                   target="_blank"
                   class="btn btn-primary w-100 text-center">
                  Inscrever
                </a>
              </div>
            </div>

            <!-- Jardinagem (fechado) -->
            <div class="col-md-4 mb-4">
              <div class="card p-3 position-relative">
                <img src="imagens/jardinagem.png" class="card-img-top mb-3" alt="Jardinagem">
                <h5 class="card-title" style="font-weight: bold;">Workshop de Jardinagem</h5>
                <p>Montagem de hortinha em vasos e cuidados básicos.</p>
                <div class="mb-2">
                  <div class="progress">
                    <div id="bar-jardinagem" class="progress-bar" role="progressbar" style="width:0%"></div>
                  </div>
                  <small><span id="count-jardinagem">0</span>/10 interessados</small>
                </div>
                <button id="btn-jardinagem" class="btn btn-outline-primary btn-sm">Tenho Interesse</button>
              </div>
            </div>

            <!-- Fotografia (fechado) -->
            <div class="col-md-4 mb-4">
              <div class="card p-3 position-relative">
                <img src="imagens/fotografia.png" class="card-img-top mb-3" alt="Fotografia">
                <h5 class="card-title" style="font-weight: bold;">Workshop de Fotografia</h5>
                <p>Fundamentos de composição, luz e enquadramento.</p>
                <div class="mb-2">
                  <div class="progress">
                    <div id="bar-fotografia" class="progress-bar" role="progressbar" style="width:0%"></div>
                  </div>
                  <small><span id="count-fotografia">0</span>/10 interessados</small>
                </div>
                <button id="btn-fotografia" class="btn btn-outline-primary btn-sm">Tenho Interesse</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- PROFESSIONALS VIEW -->
      <div class="tab-pane fade" id="professionalsView">
        <div class="container py-0">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">Profissionais</h3>
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#candidateModal">
              + Me candidatar
            </button>
          </div>
          <!-- cards APROVADOS aparecem aqui (via JS) -->
          <div id="approvedProfessionals" class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4"></div>
        </div>
      </div>

    </div><!-- fim .tab-content -->
  </div><!-- fim .container -->

  <!-- ====== MODAIS (fora das tabs) ====== -->

  <!-- Image Preview Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lx">
      <div class="modal-content bg-transparent border-0">
        <div class="modal-body p-0 position-relative">
          <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
          <img id="modalImage" src="" class="img-fluid rounded" />
        </div>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="eventForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Novo Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 row">
            <div class="col"><label class="form-label">CEP</label><input type="text" id="cep" class="form-control" placeholder="00000-000"/></div>
            <div class="col"><label class="form-label">Número</label><input type="text" id="numero" class="form-control" placeholder="123"/></div>
          </div>
          <div class="mb-3"><label class="form-label">Endereço</label><input type="text" id="address" class="form-control" readonly/></div>
          <div class="mb-3"><label class="form-label">Imagem (arquivo)</label><input type="file" id="imageFile" class="form-control" accept="image/*"/></div>
          <div class="mb-3"><label class="form-label">Título</label><input type="text" id="title" class="form-control" required/></div>
          <div class="mb-3 row">
            <div class="col"><label class="form-label">Data</label><input type="date" id="date" class="form-control" required/></div>
            <div class="col"><label class="form-label">Hora</label><input type="time" id="time" class="form-control" required/></div>
          </div>
          <div class="mb-3"><label class="form-label">ID do Gestor</label><input type="text" id="managerId" class="form-control" readonly/></div>
          <div class="mb-3"><label class="form-label">Descrição</label><textarea id="description" class="form-control" rows="3"></textarea></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Salvar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Auth Modal -->
  <div class="modal fade" id="authModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Autenticar Remoção</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="delEventId"/>
          <div class="mb-3"><label>ID do Gestor</label><input id="delId" class="form-control"/></div>
          <div class="mb-3"><label>Senha</label><input type="password" id="delPass" class="form-control"/></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" id="confirmDelete">Excluir</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Events Modal (conteúdo usado pelo JS) -->
  <div class="modal fade" id="calendarEventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="modalDateTitle" class="modal-title">Eventos do dia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="calendarCardsContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Candidate Modal -->
  <div class="modal fade" id="candidateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="candidateForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Candidatar-se como Profissional</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Foto (PNG/JPG)</label>
            <input type="file" id="candPhoto" class="form-control" accept="image/*" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Nome completo</label>
            <input type="text" id="candName" class="form-control" required />
          </div>
          <div class="mb-3 row">
            <div class="col">
              <label class="form-label">Idade</label>
              <input type="number" id="candAge" class="form-control" min="16" max="120" required />
            </div>
            <div class="col">
              <label class="form-label">Ocupação</label>
              <input type="text" id="candOccupation" class="form-control" placeholder="Ex.: Nutricionista" required />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Descrição breve</label>
            <textarea id="candBio" class="form-control" rows="3" placeholder="Experiências, especialidades, região de atendimento..."></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Contato (WhatsApp/E-mail)</label>
            <input type="text" id="candContact" class="form-control" placeholder="(43) 9xxxx-xxxx ou email@exemplo.com" />
          </div>
          <div class="mb-3">
            <label class="form-label">Currículo (PDF)</label>
            <input type="file" id="candCV" class="form-control" accept="application/pdf" required />
            <small class="text-muted">O arquivo fica salvo localmente (este MVP usa localStorage).</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" type="submit">Enviar candidatura</button>
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
/* =========================
   Constantes e Estado Base
   ========================= */
const ADMIN_ID   = 'ADMIN';
const ADMIN_PASS = 'minhaSenhaSuperSecreta';

let events = JSON.parse(localStorage.getItem('events')||'[]').map(e => ({
  ...e,
  addedToCalendar: e.addedToCalendar || false
}));

const users = JSON.parse(localStorage.getItem('users')||'[]');

const form           = document.getElementById('eventForm'),
      cardsContainer = document.getElementById('cardsContainer'),
      searchInput    = document.getElementById('searchInput'),
      managerFilter  = document.getElementById('managerFilter'),
      mapSearch      = document.getElementById('mapSearch'),
      mapList        = document.getElementById('mapSidebarList'),
      mapIframe      = document.getElementById('mapIframe'),
      placeholder    = document.getElementById('mapPlaceholder'),
      calendarEl     = document.getElementById('calendar');

// calendário (mês/ano corrente)
let currentYear, currentMonth;
const monthLabel = document.getElementById('monthLabel'),
      prevBtn    = document.getElementById('prevMonth'),
      nextBtn    = document.getElementById('nextMonth');


/* =========================
   Helpers de Persistência
   ========================= */
function saveAll() {
  localStorage.setItem('events', JSON.stringify(events));
  renderAll();
}

function getProfessionals() {
  return JSON.parse(localStorage.getItem('professionals') || '[]');
}
function saveProfessionals(list) {
  localStorage.setItem('professionals', JSON.stringify(list));
}


/* =========================
   Renderizações Principais
   ========================= */
function renderAll() {
  renderCards();
  renderCalendar();
}

function renderCards() {
  cardsContainer.innerHTML = '';
  events
    .filter(ev =>
      (ev.title.toLowerCase().includes(searchInput.value.toLowerCase()) || ev.date.includes(searchInput.value)) &&
      ev.managerId.toLowerCase().includes(managerFilter.value.toLowerCase())
    )
    .forEach(ev => {
      const col = document.createElement('div');
      col.className = 'col-md-6';
      const imgHTML = ev.imageData
        ? `<img src="${ev.imageData}" class="card-img-top mb-3" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-src="${ev.imageData}"/>`
        : '';
      col.innerHTML = `
        <div class="card p-3">
          ${imgHTML}
          <h5 class="card-title">${ev.title}</h5>
          <p class="mb-1"><strong>Data:</strong> ${ev.date} ${ev.time}</p>
          <p class="mb-1"><strong>Local:</strong>
            <a href="#" class="location-link" onclick="focusEvent('${ev.id}')">${ev.fullAddress||'—'}</a>
          </p>
          <p class="mb-1"><strong>Gestor:</strong> ${ev.managerId}</p>
          <p>${ev.description||''}</p>
          <div class="card-actions">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="askDelete('${ev.id}')">Excluir</button>
            <button type="button" class="btn btn-primary btn-sm" onclick="toggleCalendar('${ev.id}')">
              ${ev.addedToCalendar ? 'Remover do calendário' : 'Adicionar ao calendário'}
            </button>
          </div>
        </div>`;
      cardsContainer.appendChild(col);
    });
}

function renderCalendar() {
  calendarEl.innerHTML = '';

  const monthNames = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  monthLabel.textContent = `${monthNames[currentMonth]} ${currentYear}`;

  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();

  // cabeçalho
  ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'].forEach(d => {
    const hd = document.createElement('div');
    hd.className = 'day header';
    hd.textContent = d;
    calendarEl.appendChild(hd);
  });

  // slots vazios antes do primeiro dia
  for (let i = 0; i < firstDay; i++) {
    const cell = document.createElement('div');
    cell.className = 'day inactive';
    calendarEl.appendChild(cell);
  }

  // dias
  for (let date = 1; date <= daysInMonth; date++) {
    const cell = document.createElement('div');
    cell.className = 'day';
    const isoDate = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
    cell.dataset.date = isoDate;
    cell.innerHTML = `<div class="date-number">${date}</div>`;
    const evs = events.filter(e => e.addedToCalendar && e.date === isoDate);
    if (evs.length) {
      const dot = document.createElement('div'); dot.className = 'dot'; cell.appendChild(dot);
    }
    cell.addEventListener('click', () => { if (evs.length) showCalendarEvents(isoDate); });
    calendarEl.appendChild(cell);
  }
}

function renderSidebar() {
  mapList.innerHTML = '';
  events
    .filter(ev => ev.title.toLowerCase().includes(mapSearch.value.toLowerCase()))
    .forEach(ev => {
      const item = document.createElement('div'); item.className = 'list-group-item d-flex align-items-center';
      item.innerHTML = `
        ${ev.imageData ? `<img src="${ev.imageData}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;" class="me-3"/>` : ''}
        <div><strong>${ev.title}</strong><br/><small>${ev.date} ${ev.time}</small></div>`;
      item.onclick = () => focusEvent(ev.id);
      mapList.appendChild(item);
    });
}


/* =========================
   Ações de Eventos / Mapa
   ========================= */
function toggleCalendar(id) {
  const ev = events.find(e => e.id === id);
  if (!ev) return;
  ev.addedToCalendar = !ev.addedToCalendar;
  saveAll();
}

function showCalendarEvents(date) {
  const evs = events.filter(e => e.addedToCalendar && e.date === date);
  const container = document.getElementById('calendarCardsContainer');
  container.innerHTML = '';
  evs.forEach(ev => {
    const card = document.createElement('div'); card.className = 'card mb-3';
    const row = document.createElement('div'); row.className = 'row g-0';
    const imgCol = document.createElement('div'); imgCol.className = 'col-md-4';
    imgCol.innerHTML = ev.imageData ? `<img src="${ev.imageData}" class="img-fluid rounded-start"/>` : '';
    const bodyCol = document.createElement('div'); bodyCol.className = 'col-md-8';
    bodyCol.innerHTML = `
      <div class="card-body">
        <h5 class="card-title">${ev.title}</h5>
        <p class="card-text"><strong>Data:</strong> ${ev.date}</p>
        <p class="card-text"><strong>Hora:</strong> ${ev.time}</p>
        ${ev.description ? `<p class="card-text"><strong>Descrição:</strong> ${ev.description}</p>` : ''}
      </div>`;
    row.append(imgCol, bodyCol); card.appendChild(row); container.appendChild(card);
  });
  document.getElementById('modalDateTitle').textContent = date;
  bootstrap.Modal.getOrCreateInstance(document.getElementById('calendarEventModal')).show();
}

function focusEvent(id) {
  const ev = events.find(e => e.id === id);
  if (!ev) return;
  const q = encodeURIComponent(ev.fullAddress + ', Londrina-PR, Brasil');
  mapIframe.src = `https://maps.google.com/maps?q=${q}&output=embed`;
  placeholder.style.display = 'none';
  mapIframe.style.display = 'block';
}

function askDelete(id) {
  document.getElementById('delEventId').value = id;
  bootstrap.Modal.getOrCreateInstance(document.getElementById('authModal')).show();
}


/* ==================================
   Exclusão com autenticação + ADMIN
   (remove duplicidade de listeners)
   ================================== */
document.getElementById('confirmDelete').addEventListener('click', () => {
  const id   = document.getElementById('delId').value.trim();
  const pass = document.getElementById('delPass').value;

  // usuário comum
  const u = users.find(u => u.id === id && u.pass === pass);

  // admin pode apagar tudo
  const isAdmin = (id === ADMIN_ID && pass === ADMIN_PASS);

  if (!u && !isAdmin) {
    return alert('Credenciais inválidas');
  }

  const eid = document.getElementById('delEventId').value;
  const ev  = events.find(e => e.id === eid);

  // dono do evento ou admin
  if (!isAdmin && ev?.managerId !== id) {
    return alert('Sem autorização');
  }

  // remove
  events = events.filter(e => e.id !== eid);
  saveAll();
  bootstrap.Modal.getOrCreateInstance(document.getElementById('authModal')).hide();
});


/* ==================================
   Profissionais (candidatura + lista)
   ================================== */
function formatContactLink(input='') {
  const s = input.trim();
  if (!s) return '#';

  // email
  if (s.includes('@')) return `mailto:${s}`;

  // tenta WhatsApp
  const digits = s.replace(/\D/g, '');
  if (digits.length >= 10) {
    const withCountry = digits.startsWith('55') ? digits : '55' + digits;
    return `https://wa.me/${withCountry}`;
  }
  return '#';
}

function renderApprovedProfessionals() {
  const grid = document.getElementById('approvedProfessionals');
  if (!grid) return;
  grid.innerHTML = '';

  const approved = getProfessionals().filter(p => p.approved === true);
  approved.forEach(p => {
    const col = document.createElement('div');
    col.className = 'col';

    col.innerHTML = `
      <div class="card p-3">
        ${p.photoData ? `<img src="${p.photoData}" alt="${p.name}" class="card-img-top mb-3">` : ''}
        <h2 style="font-weight: bold;">${p.name}</h2>
        <h5 class="card-title">${p.occupation}${p.age ? ` • ${p.age} anos` : ''}</h5>
        <p>${p.bio ? p.bio : ''}</p>
        <div class="card-actions">
          ${p.contact ? `<a href="${formatContactLink(p.contact)}" target="_blank" class="btn btn-success">Contratar</a>` : ''}
          ${p.cvData ? `<a href="${p.cvData}" download="${(p.name || 'curriculo')}.pdf" class="btn btn-outline-primary">Baixar CV</a>` : ''}
        </div>
      </div>
    `;
    grid.appendChild(col);
  });
}

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}


/* =========================
   Workshops (interesse/inscrição)
   ========================= */
const MIN_INTEREST = 10;
const interest = {
  jardinagem: parseInt(localStorage.getItem('int-jardinagem')) || 0,
  fotografia: parseInt(localStorage.getItem('int-fotografia')) || 0
};

function renderInterest(key) {
  const cnt   = interest[key];
  const pct   = Math.min(100, (cnt / MIN_INTEREST) * 100);
  const btn   = document.getElementById(`btn-${key}`);
  const count = document.getElementById(`count-${key}`);
  const bar   = document.getElementById(`bar-${key}`);
  const clicked = localStorage.getItem(`clicked-${key}`) === '1';

  if (!btn || !count || !bar) return;

  count.textContent = cnt;
  bar.style.width  = pct + '%';

  if (clicked) {
    btn.textContent = 'Retirar Interesse';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-primary');
  } else {
    btn.textContent = 'Tenho Interesse';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-outline-primary');
  }
}

function toggleInterest(key) {
  const isClicked = localStorage.getItem(`clicked-${key}`) === '1';

  if (isClicked) {
    interest[key] = Math.max(0, interest[key] - 1);
    localStorage.setItem(`clicked-${key}`, '0');
  } else {
    interest[key] = Math.min(MIN_INTEREST, interest[key] + 1);
    localStorage.setItem(`clicked-${key}`, '1');
  }

  localStorage.setItem(`int-${key}`, interest[key]);
  renderInterest(key);
}


/* =========================
   Bootstrap & Inicialização
   ========================= */
document.addEventListener('DOMContentLoaded', () => {
  // Autenticação mínima para criar eventos
  const currentUser = localStorage.getItem('currentUser');
  if (!currentUser) {
    alert("Você precisa estar logado para criar eventos.");
    location.href = 'auth.html';
    return;
  }
  const managerIdInput = document.getElementById('managerId');
  if (managerIdInput) managerIdInput.value = currentUser;

  // mês/ano corrente
  const now = new Date();
  currentYear  = now.getFullYear();
  currentMonth = now.getMonth();

  // render inicial
  renderAll();
  renderApprovedProfessionals();

  // navegação mês
  prevBtn?.addEventListener('click', () => {
    if (currentMonth === 0) {
      currentMonth = 11; currentYear--;
    } else {
      currentMonth--;
    }
    renderAll();
  });
  nextBtn?.addEventListener('click', () => {
    if (currentMonth === 11) {
      currentMonth = 0; currentYear++;
    } else {
      currentMonth++;
    }
    renderAll();
  });

  // Mapa (carregar ao abrir aba)
  document.querySelector('[data-bs-target="#mapView"]')?.addEventListener('shown.bs.tab', () => {
    renderSidebar();
    if (placeholder) placeholder.style.display = 'flex';
    if (mapIframe) mapIframe.style.display = 'none';
  });
  mapSearch?.addEventListener('input', renderSidebar);

  // CEP → viaCEP
  document.getElementById('cep')?.addEventListener('blur', async () => {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if (cep.length === 8) {
      const d = await (await fetch(`https://viacep.com.br/ws/${cep}/json/`)).json();
      if (!d.erro) {
        document.getElementById('address').value = `${d.logradouro}, ${d.bairro}, ${d.localidade}-${d.uf}`;
      }
    }
  });

  // Modal de imagem (preview)
  const imgModal = document.getElementById('imageModal');
  imgModal?.addEventListener('show.bs.modal', event => {
    const src = event.relatedTarget?.getAttribute('data-image-src');
    if (src) document.getElementById('modalImage').src = src;
  });

  // Submissão de novo evento
  form?.addEventListener('submit', async e => {
    e.preventDefault();

    // valida gestor
    const managerId = document.getElementById('managerId').value.trim();
    if (!managerId) return alert("O campo ID do Gestor é obrigatório.");
    const gestorExiste = users.find(u => u.id === managerId);
    if (!gestorExiste) return alert("ID do Gestor não encontrado. Por favor, cadastre primeiro.");

    const id = Date.now().toString();

    // imagem do evento
    let imageData = null;
    const imgInput = document.getElementById('imageFile');
    if (imgInput?.files?.length) {
      imageData = await fileToDataURL(imgInput.files[0]);
    }

    const addr = document.getElementById('address').value;
    const num  = document.getElementById('numero').value.trim();
    const fullAddress = num ? `${addr}, ${num}` : addr;

    let lat, lng;
    try {
      const query = `${fullAddress}, Londrina-PR, Brasil`;
      const data = await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=br&limit=1&q=${encodeURIComponent(query)}`)).json();
      if (data.length) { lat = parseFloat(data[0].lat); lng = parseFloat(data[0].lon); }
      else { lat = -23.30445; lng = -51.16211; }
    } catch {
      lat = -23.30445; lng = -51.16211;
    }

    const ev = {
      id,
      imageData,
      title: document.getElementById('title').value.trim(),
      date:  document.getElementById('date').value,
      time:  document.getElementById('time').value,
      fullAddress,
      lat, lng,
      managerId,
      description: document.getElementById('description').value.trim(),
      addedToCalendar: false
    };

    events.push(ev);
    saveAll();
    form.reset();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('eventModal')).hide();
  });

  // Filtros lista
  searchInput?.addEventListener('input', renderCards);
  managerFilter?.addEventListener('input', renderCards);

  // Workshops: interesse
  document.getElementById('btn-jardinagem')?.addEventListener('click', () => toggleInterest('jardinagem'));
  document.getElementById('btn-fotografia')?.addEventListener('click', () => toggleInterest('fotografia'));
  renderInterest('jardinagem');
  renderInterest('fotografia');

  // Workshops: inscrição (mudança de rótulo)
  let isTrico=false, isPintura=false, isNatacao=false;
  document.getElementById('registerBtnTrico')?.addEventListener('click', e => {
    e.preventDefault();
    window.open(e.currentTarget.href, '_blank');
    if (!isTrico) {
      isTrico = true;
      e.currentTarget.textContent = 'Inscrito';
      e.currentTarget.classList.replace('btn-primary', 'btn-success');
    }
  });
  document.getElementById('registerBtnPintura')?.addEventListener('click', e => {
    e.preventDefault();
    window.open(e.currentTarget.href, '_blank');
    if (!isPintura) {
      isPintura = true;
      e.currentTarget.textContent = 'Inscrito';
      e.currentTarget.classList.replace('btn-primary', 'btn-success');
    }
  });
  document.getElementById('registerBtnNatacao')?.addEventListener('click', e => {
    e.preventDefault();
    window.open(e.currentTarget.href, '_blank');
    if (!isNatacao) {
      isNatacao = true;
      e.currentTarget.textContent = 'Inscrito';
      e.currentTarget.classList.replace('btn-primary', 'btn-success');
    }
  });

  /* ===== Candidatura de Profissionais (form do modal) ===== */
  const candidateForm = document.getElementById('candidateForm');
  candidateForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const photoFile   = document.getElementById('candPhoto').files[0];
    const name        = document.getElementById('candName').value.trim();
    const age         = parseInt(document.getElementById('candAge').value, 10);
    const occupation  = document.getElementById('candOccupation').value.trim();
    const bio         = document.getElementById('candBio').value.trim();
    const contact     = document.getElementById('candContact').value.trim();
    const cvFile      = document.getElementById('candCV').files[0];

    if (!photoFile || !name || !occupation || !cvFile) {
      return alert('Preencha os campos obrigatórios e anexe os arquivos.');
    }
    if (cvFile.type !== 'application/pdf') {
      return alert('O currículo deve estar em PDF.');
    }

    const photoData = await fileToDataURL(photoFile);
    const cvData    = await fileToDataURL(cvFile);

    const candidate = {
      id: 'prof_' + Date.now(),
      name,
      age: isNaN(age) ? null : age,
      occupation,
      bio,
      contact,
      photoData, // base64
      cvData,    // base64
      approved: false, // pendente até o admin aprovar no auth.html
      createdAt: new Date().toISOString()
    };

    const list = getProfessionals();
    list.push(candidate);
    saveProfessionals(list);

    candidateForm.reset();
    bootstrap.Modal.getOrCreateInstance(document.getElementById('candidateModal')).hide();
    alert('Candidatura enviada! Aguarde aprovação do gestor.');
    // não renderiza no grid: só aparece após aprovação (approved=true)

  });
});
</script>

</body>
</html>
